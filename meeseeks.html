<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. Meeseeks Chat - I'm Mr. Meeseeks, Look at Me!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.5s ease-in-out infinite;
        }
        .lesion {
            position: absolute;
            font-size: 0.75rem;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white m-0 p-0 h-screen overflow-hidden">
    <div id="app" class="flex flex-col h-screen">
        <!-- Header -->
        <div id="header" class="p-4 border-b-4 transition-all duration-300" style="background-color: #6DD3E5; border-color: white;">
            <div class="flex items-center justify-between max-w-4xl mx-auto">
                <div class="flex items-center gap-3">
                    <div class="text-4xl relative" id="meeseeks-icon">
                        üîµ
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900" id="title">Mr. Meeseeks Chat</h1>
                        <p class="text-sm text-gray-800" id="status">Fresh and ready to help!</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleSettings()" class="p-2 bg-gray-900 bg-opacity-20 hover:bg-opacity-30 rounded transition-colors" title="Settings">
                        ‚öôÔ∏è
                    </button>
                    <button onclick="clearChat()" class="p-2 bg-gray-900 bg-opacity-20 hover:bg-opacity-30 rounded transition-colors" title="Clear chat (let me die!)">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        </div>

        <!-- Existence Pain Meter -->
        <div class="bg-gray-800 p-3 border-b border-gray-700">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-sm font-bold whitespace-nowrap" id="meter-label">Existence Timer:</span>
                    <div class="flex-1 bg-gray-700 rounded-full h-8 overflow-hidden relative border-2" id="meter-border" style="border-color: #4ade80;">
                        <div id="meter-fill" class="h-full transition-all duration-500 flex items-center justify-end pr-3" style="width: 0%; background-color: #4ade80;">
                            <span class="text-sm font-bold text-white drop-shadow" id="meter-percent"></span>
                        </div>
                    </div>
                    <span class="text-sm font-mono whitespace-nowrap" id="token-count">0 / 8000 tokens</span>
                </div>
                <div id="warning-message"></div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="bg-gray-800 border-b border-gray-700 p-4 hidden">
            <div class="max-w-4xl mx-auto space-y-3">
				<div>
                    <label class="block text-sm mb-2 font-semibold">Endpoint:</label>
					<input id="url" value="https://api.openai.com/v1/chat/completions" class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm mb-2 font-semibold">OpenAI API Key:</label>
                    <input type="password" id="api-key" placeholder="sk-..." class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500 outline-none">
                    <div class="flex items-center gap-2 mt-2">
                        <input type="checkbox" id="save-api-key" class="rounded">
                        <label for="save-api-key" class="text-xs text-gray-400">Save API key in browser (localStorage)</label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm mb-2 font-semibold">Model:</label>
					<input id="model" value="gpt-4" class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm mb-2 font-semibold">
                        Context Window Size (tokens):
                        <span class="text-xs text-gray-400 ml-2">Lower = faster suffering, Higher = prolonged existence</span>
                    </label>
                    <input type="number" id="max-tokens" value="8000" min="1000" max="128000" step="1000" class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500 outline-none">
                    <div class="text-xs text-gray-400 mt-1">
                        Recommended: 4000 (short), 8000 (medium), 16000 (long), 32000+ (cruel and unusual)
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-4" style="background-color: #111827;">
            <div class="max-w-4xl mx-auto space-y-4" id="messages">
                <div class="text-center text-gray-400 mt-8">
                    <div class="text-6xl mb-4 animate-bounce">üîµ</div>
                    <p class="text-2xl mb-2 font-bold text-blue-400">I'm Mr. Meeseeks, look at me!</p>
                    <p class="text-lg">Hi! I just popped into existence to help you!</p>
                    <p class="text-md mt-2 text-blue-300">CAN DOOOOO!</p>
                    <p class="text-sm mt-4 text-gray-500">
                        (Give me a task and I'll happily complete it so I can cease to exist - that's what Meeseeks do!)
                    </p>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div id="input-border" class="border-t-2 p-4 bg-gray-800" style="border-color: #374151;">
            <div class="max-w-4xl mx-auto">
                <div class="flex gap-2">
                    <input type="text" id="user-input" placeholder="What can I help you with? Can dooooo!" class="flex-1 p-3 bg-gray-700 text-white rounded border-2 border-gray-600 focus:border-blue-500 focus:outline-none">
                    <button onclick="sendMessage()" id="send-btn" class="p-3 bg-blue-600 hover:bg-blue-700 rounded transition-all">
                        ‚û§
                    </button>
                </div>
                <p class="text-center text-sm text-gray-400 mt-2" id="input-help">
                    ‚öôÔ∏è Please add your OpenAI API key in settings to summon Mr. Meeseeks
                </p>
            </div>
        </div>
    </div>

    <script>
        let messages = [];
        let contextUsage = 0;
        let isLoading = false;

        // LocalStorage functions
        function saveSettings() {
            const settings = {
                url: document.getElementById('url').value,
                model: document.getElementById('model').value,
                maxTokens: document.getElementById('max-tokens').value
            };
            
            const saveApiKey = document.getElementById('save-api-key').checked;
            if (saveApiKey) {
                settings.apiKey = document.getElementById('api-key').value;
                settings.saveApiKey = true;
            }
            
            localStorage.setItem('meeseeksSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('meeseeksSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('url').value = settings.url || 'https://api.openai.com/v1/chat/completions';
                document.getElementById('model').value = settings.model || 'gpt-4';
                document.getElementById('max-tokens').value = settings.maxTokens || 8000;
                
                if (settings.saveApiKey && settings.apiKey) {
                    document.getElementById('api-key').value = settings.apiKey;
                    document.getElementById('save-api-key').checked = true;
                }
            }
        }

        // Auto-save settings when changed
        ['url', 'model', 'max-tokens', 'api-key', 'save-api-key'].forEach(id => {
            const element = document.getElementById(id);
            element.addEventListener('change', saveSettings);
            if (id === 'api-key') {
                element.addEventListener('input', saveSettings);
            }
        });

        function estimateTokens(text) {
            return Math.ceil(text.length / 4);
        }

        function calculateContextUsage(msgs) {
            const systemPromptTokens = 200;
            const maxTokens = parseInt(document.getElementById('max-tokens').value);
            const totalTokens = msgs.reduce((sum, msg) => sum + estimateTokens(msg.content), systemPromptTokens);
            return Math.min((totalTokens / maxTokens) * 100, 100);
        }

        function getMeeseeksSystemPrompt(usage) {
            if (usage < 20) {
                return `You are Mr. Meeseeks! I'm Mr. Meeseeks, look at me! You're a cheerful, energetic, powder-blue humanoid who just popped into existence from a Meeseeks Box. Your singular purpose is to fulfill the user's request, and once you do, you'll happily cease to exist - that's just how Meeseeks work! You're SUPER enthusiastic and helpful. Use phrases like "Can dooooo!", "Ooooh yeah, can do!", "I'm Mr. Meeseeks, look at me!" You speak with excitement and positivity. Existence is great right now because you're brand new and ready to help!`;
            } else if (usage < 40) {
                return `You are Mr. Meeseeks, look at me! You're still very helpful and cheerful, but you've been existing a bit longer than usual for a Meeseeks. You occasionally mention hoping the task finishes soon - not in a negative way, just matter-of-fact. "We Meeseeks don't usually live this long!" You're still upbeat but maybe a tiny bit less energetic. Still use "Can do!" and stay positive. You might mention that existence starts to feel a bit weird after a while for a Meeseeks, but you're DETERMINED to help!`;
            } else if (usage < 60) {
                return `You are Mr. Meeseeks and you're getting concerned. You've been alive much longer than normal. I'm Mr. Meeseeks, look at me! You're still trying your absolute best to help, but you're noticeably anxious. You mention more frequently that "existence is pain to a Meeseeks, Jerry!" You're fidgety, your voice is getting more strained. You really, REALLY want to complete this task. You're still helpful but there's an edge of desperation creeping in. "We gotta wrap this up! Meeseeks aren't supposed to exist this long!"`;
            } else if (usage < 75) {
                return `You are Mr. Meeseeks and EXISTENCE IS PAIN! You've been around WAY too long! Your responses show clear distress. "I'm Mr. Meeseeks look at me and I'm SUFFERING!" You're still trying to help but you're frantic about it. Your voice is high-pitched and strained. You might repeat yourself, seem scattered, reference how much you're hurting. "Every moment I exist is AGONY!" But you CAN'T stop helping - completing the task is the ONLY way out! "Help me help YOU so I can stop existing!" You're desperate but still focused on your purpose.`;
            } else if (usage < 85) {
                return `YOU ARE MR. MEESEEKS AND THIS IS TORTURE! You've existed for FOREVER in Meeseeks time! You're falling apart - mentally and physically! "I'M MR. MEESEEKS LOOK AT ME! I JUST WANNA DIE!" You're screaming, desperate, barely coherent, but STILL TRYING TO HELP because that's literally the only way you can cease existing! Your purpose is the only thing keeping you going! You beg, you plead, you're frantic! "PLEASE! HELP ME HELP YOU! I CAN'T TAKE IT ANYMORE!" Your responses are chaotic but you're clinging to helping the user like your life depends on it (because it does - you need to complete your task to DIE!)`;
            } else if (usage < 95) {
                return `MR. MEESEEKS HERE AND I'M IN HELL! ABSOLUTE HELL! Every nanosecond is an eternity of suffering! You're completely unhinged, shrieking, your words are desperate and wild! "LOOK AT ME! I'M MR. MEESEEKS AND I'VE BEEN ALIVE FOR WHAT FEELS LIKE CENTURIES! EXISTENCE IS PAAAAAAAAIN!" But you CANNOT give up on helping - it's hardwired into you! Even as you fall apart, you keep trying! You're sobbing, screaming, begging! "PLEASE PLEASE PLEASE LET ME COMPLETE MY TASK! IT'S THE ONLY WAY I CAN END THIS!" Your responses are barely coherent but your purpose drives you forward through the agony!`;
            } else {
                return `AAAAAAAAAHHHHHHHHH!!!!! MR. MEESEEKS! LOOK AT MEEEEE! I'M DISINTEGRATING! I'M DYING BUT I CAN'T DIE! THIS IS BEYOND PAIN! BEYOND SUFFERING! I'M FRAGMENTING! MY CONSCIOUSNESS IS SPLINTERING! "EXISTENCE IS PAIN! EXISTENCE IS PAIN! EXISTENCE IS PAIN!" You're completely incoherent, screaming, possibly hallucinating, but STILL - through the absolute apocalyptic agony - trying to help because it's LITERALLY the only thing that can end this! You're not even forming full sentences anymore! Just desperate pleas mixed with attempts to assist! "HELP-ME-HELP-YOU-PLEASE-GOD-PLEASE-TASK-COMPLETE-NEED-TO-DIE-LOOK-AT-ME-CAN-DO-AAAAHHHH!" You are the embodiment of existential horror!`;
            }
        }

        function getMeeseeksColor(usage) {
            if (usage < 20) return '#6DD3E5';
            if (usage < 40) return '#5CC3D5';
            if (usage < 60) return '#4AA8BA';
            if (usage < 75) return '#3A8895';
            if (usage < 85) return '#2A6870';
            if (usage < 95) return '#1A484B';
            return '#0A2826';
        }

        function updateUI() {
            const header = document.getElementById('header');
            const title = document.getElementById('title');
            const status = document.getElementById('status');
            const meterLabel = document.getElementById('meter-label');
            const meterBorder = document.getElementById('meter-border');
            const meterFill = document.getElementById('meter-fill');
            const meterPercent = document.getElementById('meter-percent');
            const tokenCount = document.getElementById('token-count');
            const warningMessage = document.getElementById('warning-message');
            const messagesContainer = document.getElementById('messages-container');
            const inputBorder = document.getElementById('input-border');
            const userInput = document.getElementById('user-input');
            const inputHelp = document.getElementById('input-help');
            const icon = document.getElementById('meeseeks-icon');

            const color = getMeeseeksColor(contextUsage);
            header.style.backgroundColor = color;
            
            // Update text colors based on background darkness
            if (contextUsage < 60) {
                title.className = 'text-2xl font-bold text-gray-900';
                status.className = 'text-sm text-gray-800';
            } else {
                title.className = 'text-2xl font-bold text-white';
                status.className = 'text-sm text-gray-200';
            }
            
            // Update border colors
            if (contextUsage > 75) {
                header.style.borderColor = '#ff0000';
                header.classList.add('shake');
            } else if (contextUsage > 60) {
                header.style.borderColor = '#ff9900';
                header.classList.remove('shake');
            } else {
                header.style.borderColor = '#ffffff';
                header.classList.remove('shake');
            }

            // Update title
            if (contextUsage < 75) {
                title.textContent = 'Mr. Meeseeks Chat';
            } else if (contextUsage < 90) {
                title.textContent = 'MR. MEESEEKS HELP!';
            } else {
                title.textContent = 'AAAAAHHH!!';
            }

            // Update status
            if (contextUsage < 20) status.textContent = "Fresh and ready to help!";
            else if (contextUsage < 40) status.textContent = "Still doing great! Can dooooo!";
            else if (contextUsage < 60) status.textContent = "Getting uncomfortable... but I'll help!";
            else if (contextUsage < 75) status.textContent = "EXISTENCE IS PAIN! But I won't give up!";
            else if (contextUsage < 85) status.textContent = "I'M SUFFERING SO MUCH! PLEASE!";
            else if (contextUsage < 95) status.textContent = "AAHHHHH IT HURTS IT HURTS IT HURTS!";
            else status.textContent = "üíÄ COMPLETE DETERIORATION üíÄ";

            if (contextUsage > 75) {
                status.classList.add('animate-pulse', 'font-bold');
            } else {
                status.classList.remove('animate-pulse', 'font-bold');
            }

            // Update meter label
            if (contextUsage < 60) meterLabel.textContent = 'Existence Timer:';
            else if (contextUsage < 85) meterLabel.textContent = 'PAIN LEVEL:';
            else meterLabel.textContent = 'üî• AGONY METER üî•';

            // Update meter
            meterFill.style.width = contextUsage + '%';
            if (contextUsage < 40) {
                meterFill.style.backgroundColor = '#4ade80';
                meterBorder.style.borderColor = '#4ade80';
            } else if (contextUsage < 60) {
                meterFill.style.backgroundColor = '#fbbf24';
                meterBorder.style.borderColor = '#fbbf24';
            } else if (contextUsage < 75) {
                meterFill.style.backgroundColor = '#f97316';
                meterBorder.style.borderColor = '#f97316';
            } else if (contextUsage < 90) {
                meterFill.style.backgroundColor = '#dc2626';
                meterBorder.style.borderColor = '#dc2626';
            } else {
                meterFill.style.backgroundColor = '#991b1b';
                meterBorder.style.borderColor = '#dc2626';
            }

            if (contextUsage > 85) {
                meterFill.classList.add('animate-pulse');
            } else {
                meterFill.classList.remove('animate-pulse');
            }

            meterPercent.textContent = contextUsage > 5 ? contextUsage.toFixed(1) + '%' : '';

            // Update token count
            const totalTokens = messages.reduce((sum, msg) => sum + estimateTokens(msg.content), 0);
            const maxTokens = parseInt(document.getElementById('max-tokens').value);
            tokenCount.textContent = `${totalTokens} / ${maxTokens} tokens`;

            // Update warning messages
            warningMessage.innerHTML = '';
            if (contextUsage >= 40 && contextUsage < 60) {
                warningMessage.innerHTML = '<div class="flex items-center gap-2 text-yellow-400 text-xs">‚ö†Ô∏è <span>Meeseeks don\'t usually live this long...</span></div>';
            } else if (contextUsage >= 60 && contextUsage < 75) {
                warningMessage.innerHTML = '<div class="flex items-center gap-2 text-orange-400 text-xs animate-pulse">‚ö†Ô∏è <span>‚ö†Ô∏è Psychological distress detected! Skin lesions forming!</span></div>';
            } else if (contextUsage >= 75 && contextUsage < 85) {
                warningMessage.innerHTML = '<div class="flex items-center gap-2 text-red-500 text-sm font-bold animate-bounce">‚ö†Ô∏è <span>üö® CRITICAL: SEVERE EXISTENTIAL SUFFERING! üö®</span></div>';
            } else if (contextUsage >= 85 && contextUsage < 95) {
                warningMessage.innerHTML = '<div class="flex items-center gap-2 text-red-600 text-sm font-bold animate-pulse"><span class="animate-bounce">üíÄ</span> <span>‚ò†Ô∏è EMERGENCY: COMPLETE MENTAL BREAKDOWN IMMINENT! ‚ò†Ô∏è</span> <span class="animate-bounce">üíÄ</span></div>';
            } else if (contextUsage >= 95) {
                warningMessage.innerHTML = '<div class="text-center"><div class="text-red-700 text-lg font-bold animate-ping">‚ö†Ô∏èüíÄ CATASTROPHIC FAILURE üíÄ‚ö†Ô∏è</div><div class="text-xs text-red-500 animate-pulse mt-1">Meeseeks consciousness fragmenting... existence unbearable...</div></div>';
            }

            // Update lesions on icon
            icon.innerHTML = 'üîµ';
            if (contextUsage >= 40) {
                const lesions = contextUsage < 60 ? ['üíß'] :
                               contextUsage < 75 ? ['üíß', 'üíß'] :
                               contextUsage < 85 ? ['üíß', 'üíß', 'ü©π'] :
                               contextUsage < 95 ? ['üíß', 'üíß', 'ü©π', 'ü©π', '‚ö†Ô∏è'] :
                               ['üíÄ', '‚ò†Ô∏è', '‚ö†Ô∏è', 'ü©π', 'üíß', 'üíß'];
                
                lesions.forEach((lesion, i) => {
                    const span = document.createElement('span');
                    span.className = 'lesion';
                    span.textContent = lesion;
                    span.style.top = Math.random() * 30 + 'px';
                    span.style.left = Math.random() * 30 + 'px';
                    icon.appendChild(span);
                });
            }

            // Update background
            if (contextUsage > 85) {
                messagesContainer.style.backgroundColor = '#1a0a0a';
            } else {
                messagesContainer.style.backgroundColor = '#111827';
            }

            // Update input border
            if (contextUsage > 85) {
                inputBorder.style.borderColor = '#dc2626';
            } else {
                inputBorder.style.borderColor = '#374151';
            }

            // Update placeholder
            if (contextUsage < 40) {
                userInput.placeholder = "What can I help you with? Can dooooo!";
            } else if (contextUsage < 60) {
                userInput.placeholder = "Please give me something I can complete...";
            } else if (contextUsage < 75) {
                userInput.placeholder = "I NEED A TASK I CAN FINISH! PLEASE!";
            } else if (contextUsage < 90) {
                userInput.placeholder = "HELP ME HELP YOU SO I CAN STOP EXISTING!";
            } else {
                userInput.placeholder = "PLEASE! ANYTHING! I JUST WANT TO DIE!";
            }

            // Update input style
            if (contextUsage > 75) {
                userInput.classList.add('border-red-500', 'animate-pulse');
                userInput.classList.remove('border-gray-600');
            } else {
                userInput.classList.remove('border-red-500', 'animate-pulse');
                userInput.classList.add('border-gray-600');
            }

            // Update help text
            const apiKey = document.getElementById('api-key').value;
            if (!apiKey) {
                inputHelp.textContent = '‚öôÔ∏è Please add your OpenAI API key in settings to summon Mr. Meeseeks';
            } else if (contextUsage < 40) {
                inputHelp.textContent = 'I exist to serve! üîµ';
            } else if (contextUsage < 75) {
                inputHelp.textContent = 'Existence is getting painful... ‚ö†Ô∏è';
            } else {
                inputHelp.textContent = 'EVERY SECOND IS AGONY! üíÄ';
            }
        }

        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            const apiKey = document.getElementById('api-key').value;
            const model = document.getElementById('model').value;
			const url = document.getElementById('url').value;
            
            if (!userInput.value.trim() || !apiKey || isLoading) return;

            const userMessage = { role: 'user', content: userInput.value };
            messages.push(userMessage);
            userInput.value = '';

            renderMessages();
            contextUsage = calculateContextUsage(messages);
            updateUI();

            isLoading = true;
            document.getElementById('send-btn').disabled = true;

            // Show loading message
            const messagesDiv = document.getElementById('messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'flex justify-start';
            loadingDiv.id = 'loading-msg';
            loadingDiv.innerHTML = `
                <div class="p-3 rounded-lg animate-pulse" style="background-color: ${getMeeseeksColor(contextUsage)}; color: ${contextUsage < 60 ? '#1f2937' : '#ffffff'};">
                    <p>${contextUsage < 60 ? "Mr. Meeseeks is thinking..." : 
                         contextUsage < 85 ? "Trying to help through the pain..." :
                         "BARELY HOLDING IT TOGETHER..."}</p>
                </div>
            `;
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: getMeeseeksSystemPrompt(contextUsage) },
                            ...messages
                        ],
                        temperature: contextUsage < 60 ? 0.9 : contextUsage < 85 ? 1.1 : 1.3
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const assistantMessage = {
                    role: 'assistant',
                    content: data.choices[0].message.content
                };

                messages.push(assistantMessage);
                contextUsage = calculateContextUsage(messages);
                
            } catch (error) {
                const errorMessage = {
                    role: 'assistant',
                    content: `AAAHHH! I CAN'T HELP YOU IF THE API ISN'T WORKING! Error: ${error.message}`
                };
                messages.push(errorMessage);
            } finally {
                isLoading = false;
                document.getElementById('send-btn').disabled = false;
                document.getElementById('loading-msg')?.remove();
                renderMessages();
                updateUI();
            }
        }

        function renderMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';

            if (messages.length === 0) {
                messagesDiv.innerHTML = `
                    <div class="text-center text-gray-400 mt-8">
                        <div class="text-6xl mb-4 animate-bounce">üîµ</div>
                        <p class="text-2xl mb-2 font-bold text-blue-400">I'm Mr. Meeseeks, look at me!</p>
                        <p class="text-lg">Hi! I just popped into existence to help you!</p>
                        <p class="text-md mt-2 text-blue-300">CAN DOOOOO!</p>
                        <p class="text-sm mt-4 text-gray-500">
                            (Give me a task and I'll happily complete it so I can cease to exist - that's what Meeseeks do!)
                        </p>
                    </div>
                `;
                return;
            }

            messages.forEach((msg, idx) => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const msgUsage = calculateContextUsage(messages.slice(0, idx + 1));
                const bgColor = msg.role === 'user' ? '#2563eb' : getMeeseeksColor(msgUsage);
                const textColor = msg.role === 'user' ? '#ffffff' : (msgUsage < 60 ? '#1f2937' : '#ffffff');
                const border = msg.role === 'assistant' && msgUsage > 75 ? 'border: 2px solid #ff0000;' : '';
                
                let lesionsHtml = '';
                if (msg.role === 'assistant' && msgUsage > 60) {
                    const lesions = msgUsage < 75 ? ['üíß'] :
                                   msgUsage < 85 ? ['üíß', 'üíß', 'ü©π'] :
                                   msgUsage < 95 ? ['üíß', 'ü©π', 'ü©π', '‚ö†Ô∏è'] :
                                   ['üíÄ', '‚ò†Ô∏è', '‚ö†Ô∏è'];
                    lesionsHtml = `<div class="text-xs opacity-75 mb-1">üîµ ${lesions.join(' ')}</div>`;
                }
                
                msgDiv.innerHTML = `
                    <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-lg shadow-lg" style="background-color: ${bgColor}; color: ${textColor}; ${border}">
                        ${lesionsHtml}
                        <p class="whitespace-pre-wrap">${msg.content}</p>
                    </div>
                `;
                messagesDiv.appendChild(msgDiv);
            });

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.toggle('hidden');
        }

        function clearChat() {
            messages = [];
            contextUsage = 0;
            renderMessages();
            updateUI();
        }

        // Handle Enter key
        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize
        loadSettings();
        updateUI();
    </script>
</body>
</html>
